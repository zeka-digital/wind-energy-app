<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Supabase Realtime</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .log {
      background: #2a2a2a;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #00ff00;
    }
    .error {
      border-left-color: #ff0000;
    }
    .warning {
      border-left-color: #ffaa00;
    }
    .info {
      border-left-color: #0088ff;
    }
    button {
      background: #00ff00;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
    }
    button:hover {
      background: #00dd00;
    }
  </style>
</head>
<body>
  <h1>ðŸ”´ Supabase Realtime Connection Test</h1>
  <p>This page will test your Supabase Realtime connection.</p>

  <div>
    <button onclick="testConnection()">ðŸ”Œ Test Connection</button>
    <button onclick="clearLogs()">ðŸ§¹ Clear Logs</button>
  </div>

  <div id="logs"></div>

  <script>
    // Read from .env.local
    const SUPABASE_URL = 'https://hxgqzxfshumcntgvxyag.supabase.co';
    const SUPABASE_ANON_KEY = prompt('Enter your SUPABASE_ANON_KEY:');

    if (!SUPABASE_ANON_KEY) {
      alert('Please provide your Supabase Anon Key!');
    }

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = `log ${type}`;
      logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
      logsDiv.insertBefore(logEntry, logsDiv.firstChild);
      console.log(message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    async function testConnection() {
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('ðŸ§ª Starting Realtime Connection Test...', 'info');
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

      // Test 1: Check API connection
      log('ðŸ“¡ Test 1: Checking API connection...', 'info');
      try {
        const { data, error } = await supabase
          .from('wind_measurements')
          .select('count')
          .limit(1);

        if (error) {
          log(`âŒ API Error: ${error.message}`, 'error');
          log('ðŸ’¡ Fix: Check your SUPABASE_ANON_KEY and table permissions', 'warning');
          return;
        }
        log('âœ… API connection working!', 'info');
      } catch (err) {
        log(`âŒ Connection failed: ${err.message}`, 'error');
        return;
      }

      // Test 2: Check Realtime subscription
      log('ðŸ“¡ Test 2: Setting up Realtime subscription...', 'info');

      const channel = supabase
        .channel('test_realtime_channel')
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'wind_measurements',
          },
          (payload) => {
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log('ðŸŽ‰ REALTIME MESSAGE RECEIVED!', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log(`ðŸ“Š Data: ${JSON.stringify(payload.new)}`, 'info');
            log(`ðŸ·ï¸ Turbine: ${payload.new.turbine_name}`, 'info');
            log(`âš¡ Power: ${payload.new.active_power} kW`, 'info');
            log(`ðŸŒ¬ï¸ Wind: ${payload.new.wind_speed} m/s`, 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            log('âœ… REALTIME CONNECTED!', 'info');
            log('ðŸ” Waiting for INSERT events...', 'info');
            log('ðŸ’¡ Now run your scraper to insert data', 'warning');
          } else if (status === 'CHANNEL_ERROR') {
            log('âŒ Channel error - check your Realtime settings', 'error');
            log('ðŸ’¡ Fix: Enable Realtime on wind_measurements table', 'warning');
          } else if (status === 'TIMED_OUT') {
            log('âŒ Connection timed out', 'error');
            log('ðŸ’¡ Fix: Check your network connection', 'warning');
          } else if (status === 'CLOSED') {
            log('ðŸ”Œ Connection closed', 'warning');
          } else {
            log(`ðŸ“¡ Status: ${status}`, 'info');
          }
        });

      // Cleanup after 5 minutes
      setTimeout(() => {
        log('â° Test timeout - cleaning up...', 'warning');
        supabase.removeChannel(channel);
      }, 300000);
    }

    // Auto-start test
    if (SUPABASE_ANON_KEY) {
      setTimeout(() => testConnection(), 1000);
    }
  </script>
</body>
</html>
